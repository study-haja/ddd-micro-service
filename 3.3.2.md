## 3.3.2 내부영역 - 업무 규칙

- 서비스와 도메인은 클린 아키텍처의 유스케이스와 엔티티의 역할과 같다. 도메인은 비즈니스 개념을 표현하고 서비스는 도메인을 활용해 시스템 흐름 처리를 수행한다.
- 이러한 내부영역, 특히 서비스와 도메인의 관계를 구현할 때 참고할 만한 유용한 패턴은 **트랜잭션 스크립트 패턴** 과 **도메인 모델 패턴** 이다.



### 트랜젝션 스크립트 패턴

- 모든 비즈니스 행위, 즉 무엇인가를 수행하는 책임은 서비스에 있다. 서비스가 비즈니스 절차에 따라 절차적으로 도메인 객체를 이용해 모든 처리를 수행한다.
- 문제점
  - 이런 방식에서는 시간이 지남에 따라 서비스가 비대해지고 도메인 객체는 점점 정보 묶음의 역할만 수행하게 될 뿐이다.
  - 비슷한 유스케이스의 경우 서비스에 중복되는 코드가 계속 생겨날 수 있다. 이러한 점이 유지보수를 어렵게 할 수 있다.
- 비즈니스가 복잡해질 경우 서비스 코드의 양이 점점 증가하는 등 데이터베이스 중심 아키텍처에서 겪었던 문제점이 발생할 여지가 크다. 따라서 간단한 비즈니스를 처리할 때 적용하는 것이 좋다.



### 도메인 모델 패턴

- 도메인 모델은 도베인 객체가 데이터뿐만 아니라 비즈니스 행위를 가지고 있으며, 도메인 객체가 소유한 데이터는 도메인 객체가 제공하는 행위에 의해 은닉된다.
- 서비스는 비즈니스 유스케이스를 구현하기 위해 서비스의 행위를 도메인 객체에 일부분 위임해서 처리한다.
- 장점
  - 서비스의 책임들이 도메인으로 적절히 분산되기 때문에 서비스가 비대해지지 않고 서비스 메서드는 단순해진다.
  - 거대한 서비스 클래스 대신 각기 적절한 책임을 가진 여러 클래스로 구성되므로 이해하기 쉽고 관리 및 테스트하기 쉽다.
  - 코드의 양을 줄이고 재사용성도 높일수 있다.



### 도메인 주도 설계의 애그리거트 패턴

- 서비스에서 여러 의존하는 클래스를 대상으로 어떤 작업을 처리한다고 했을때, 의존하는 클래스가 추가가 될경우 서비스의 코드가 변경되어야한다. 이때 코드를 변경하지 않으면 비즈니스 일관성이 깨지게 된다. 이를 개선하기 위해서 의존하는 클래스들을 하나의 개념(Root Entity)으로 분리한 것이 애그리거트 패턴이다.
- 애그리거트를 한 단위로 일관되게 처리하기 위해서 다음과 같은 규칙을 부여함
  - 애그리거트 루트만 참조한다.
  - 애그리거트 내 상세 클래스를 바로 참조하기 않고 루트를 통해 참조해야 한다. 수정할 때도 마찬가지다.
  - 애그리거트 간의 참조는 객체를 직접 참조하는 대신 기본 키를 사용한다.
  - 기본 키를 사용하면 느슨하게 연관되고 수정이 필요하지 않은 애그리거트를 함께 수정하는 실수를 방지한다.
  - 하나의 트랜젝션으로 하나의 애그리거트만 생성 및 수정한다.