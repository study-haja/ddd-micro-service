## 도서 대출 마이크로서비스 개발

* 앞서 설계한 도서 대출 예시를 가지고 개발하려고 한다.



## 구현 기능 소개

* 도서 대출에 대한 기능의 세부 구현 내용은 다음과 같다.
* 도서 대출
  * 대출 처리에 대한 비즈니스 로직 구현
  * 대출 시 도서 서비스와 연계해 상세 도서 정보 조회 (페인을 통한 동기 호출)
  * 대출 시 도서 서비스와 연계해 재고 감소 처리 (카프카)
  * 대출 시 카탈로그 서비스에 대출 도서 집계 처리 (카프카)
* 도서 반납
  * 반납 처리에 대한 비즈니스 로직 구현
  * 반납 시 도서 서비스와 연계해 재구 증가 처리 (카프카)
* 도서 연체
  * 연체 처리에 대한 비즈니스 로직 구현
  * 연체 시 대출 불가 처리
* 연체 해제
  * 연체 해제를 위해 사용자 서비스와 연계해 포인트를 통해 결제 처리 (페인을 통한 동기 호출)



## 내부 아키텍처 결정

* 도서 대출 시스템은 다음을 적용했다.
  * 도메인 모델 중심의 헥사고날 아키텍처
  * ORM
  * 동기 통신 : 페인
  * 비동기 통신 : 카프카



## API 설계

* 도서 대출 API
  * 메소드 : POST
  * URI : /rentals/{userId}/rentedItem/{book}
    * userId는 사용자 id, book은 서적 일련번호
  * 응답은 대출 정보를 반환 (id, 렌탈 상태 등)
* 도서 반납 API
  * 메소드 : DELETE
  * URI : /rentals/{userId}/rentedItem/{book}
    * userId는 사용자 id, book은 서적 일련번호
  * 응답은 대출 정보를 반환 (id, 렌탈 상태 등)
* 도서 연체 API
  * 메소드 : POST
  * URI : /rentals/{userId}/OverdueItem/{book}
    * userId는 사용자 id, book은 서적 일련번호
  * 응답은 연체된 책 번호를 반환
* 연체된 도서 반납 API
  * 메소드 : DELETE
  * URI : /rentals/{userId}/OverdueItem/{book}
    * userId는 사용자 id, book은 서적 일련번호
  * 응답은 대출했던 정보를 반환 (id, 렌탈 상태 등)
    * 요금을 내야지 도서 대출 가능 상태가 된다.



## 도메인 모델링

* 이벤트 스토밍을 통해 애그리거트들이 구체적으로 모델링된다.
* 데이터 모델링에 익숙한 사람은 비즈니스를 테이블화하고 정규화하려고 할 것이다.
* 하지만 이러한 경우 특정 데이터베이스에 의존될 가능성 및 사람이 이해하기 어려울 수도 있다.
* 따라서 객체를 데이터와 그 데이터를 이용한 기능 처리를 담당하는 로봇이라 생각하고 모델링을 진행해보자.
* 도서 대출은 다음과 같다.
  * 도서 대출 로봇이 있고 이 로봇은 현재 대출한 도서와 현재 연체된 도서, 지금까지 대출했다 반납한 도서의 이력을 모두 가지고 있다.
  * 이 로봇이 하는 일은 다음과 같다.
    1. 대출, 반납에 대한 책임을 가지고 있고 대출 시 대출 아이템을 대출 메모리에 기억한다.
    2. 대출일자를 넘어서도 도서가 반납되지 않으면 연체 메모리에 이동시켜 기록하고 이때는 해당 사용자의 대출 가능 여부를 대출 불가 상태로 만들어 이후로는 대출을 거부한다.
    3. 도서가 반납되면 대출 메모리 또는 연체 메모리에 있던 도서를 반납 메모리로 옮긴다. 그리고 반납 메모리의 기록은 개인의 대출도서 내역으로 오랫동안 보관한다
  * 따라서 대출은 대출 아이템, 연체 아이템, 반납 아이템 3개의 메모리 객체로 모델링이 가능하다.
  * 또한 대출 가능 상태에 대한 표준타입을 가질 수 있다.



## 유스케이스 흐름

* 시퀀스 다이어그램을 만들어 도서 대출 반납의 흐름을 볼 수 있다.

* 이러면 도서 대출 및 도서 반납의 비즈니스 로직은 도메인 모델에 응집돼 있음을 확인할 수 있다.

* 서비스 구현체는 비즈니스 로직 외의 흐름 제어 및 저장 처리, 이벤트 메세지 처리를 담당하고 비즈니스 로직은 도메인이 담당해야 한다.

  

#### 참고

* API 설계는 언제?
  * UI 설계를 먼저하고 API를 설계하면 프론트에 의존되는 API가 발생
  * API 중복이 발생 -> 재사용 불가
  * 도메인 모델을 정의해야한 서비스에서 제공할 API가 정리되고 구체화될 수 있음
  * 따라서 UI설계와 도메인 모델링이 어느 정도 진행된 후 API를 설계 하는 것이 좋다.

